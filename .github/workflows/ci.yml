name: CI
# Deploys backend (EC2), frontend (S3+CloudFront), landing (S3) with Discord notifications

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: sophikon_user
          POSTGRES_PASSWORD: Soph1k0n_Dev_2026!
          POSTGRES_DB: sophikon_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        enable-cache: true

    - name: Set up Python
      env:
        UV_CACHE_DIR: /tmp/.uv-cache
      run: uv python install 3.13

    - name: Install dependencies
      run: |
        uv sync --all-extras --dev

    - name: Lint with Ruff
      run: |
        uv run ruff check .
        uv run ruff format --check .

    - name: Run migrations
      env:
        DATABASE_URL: postgresql+asyncpg://sophikon_user:Soph1k0n_Dev_2026!@localhost:5432/sophikon_test
        SECRET_KEY: ci-test-only-not-a-real-secret-key-0000000000
      run: |
        uv run alembic upgrade head

    - name: Run tests
      env:
        DATABASE_URL: postgresql+asyncpg://sophikon_user:Soph1k0n_Dev_2026!@localhost:5432/sophikon_test
        SECRET_KEY: ci-test-only-not-a-real-secret-key-0000000000
      run: |
        uv run pytest

  deploy-backend:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /opt/sophikon
          sudo git pull
          sudo docker compose up -d --build

    - name: Notify Discord
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          MSG="✅ **Backend deploy succeeded** — ${{ github.event.head_commit.message }}"
        else
          MSG="❌ **Backend deploy failed** — ${{ github.event.head_commit.message }}"
        fi
        curl -s -H "Content-Type: application/json" \
          -d "{\"content\": \"$MSG\"}" \
          "${{ secrets.DISCORD_DEPLOYS_WEBHOOK }}" > /dev/null

  deploy-frontend:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm install

    - name: Build
      env:
        VITE_API_BASE_URL: https://api.sophikon.org/api/v1
      run: npm run build

    - name: Deploy to S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
      run: aws s3 sync dist/ s3://${{ secrets.S3_FRONTEND_BUCKET }} --delete

    - name: Invalidate CloudFront cache
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
      run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

    - name: Notify Discord
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          MSG="✅ **Frontend deploy succeeded** — ${{ github.event.head_commit.message }}"
        else
          MSG="❌ **Frontend deploy failed** — ${{ github.event.head_commit.message }}"
        fi
        curl -s -H "Content-Type: application/json" \
          -d "{\"content\": \"$MSG\"}" \
          "${{ secrets.DISCORD_DEPLOYS_WEBHOOK }}" > /dev/null

  deploy-landing:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Replace placeholders
      run: |
        sed -i 's|__APP_URL__|https://app.sophikon.org|g' landing/index.html

    - name: Deploy to S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
      run: |
        aws s3 sync landing/ s3://${{ secrets.S3_LANDING_BUCKET }} --delete

    - name: Notify Discord
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          MSG="✅ **Landing deploy succeeded** — ${{ github.event.head_commit.message }}"
        else
          MSG="❌ **Landing deploy failed** — ${{ github.event.head_commit.message }}"
        fi
        curl -s -H "Content-Type: application/json" \
          -d "{\"content\": \"$MSG\"}" \
          "${{ secrets.DISCORD_DEPLOYS_WEBHOOK }}" > /dev/null
